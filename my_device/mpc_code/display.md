使用了 **模型预测控制**（MPC）来实现一个四轮全向底盘的轨迹跟踪任务。
MPC是一种基于优化的控制方法，通过预测系统的未来行为并优化控制输入，使得系统能够在动态环境中做出最优决策。

### 基本原理

1. **模型预测控制 (MPC)**：

   - **控制目标**：MPC通过在每个时间步预测未来的系统状态，优化当前的控制输入，以便系统能够追踪目标轨迹。
   - **优化问题**：在每个时刻，MPC通过求解一个优化问题来生成控制输入。这个优化问题的目标是最小化预测的状态与目标之间的误差，同时满足系统的约束条件（如控制输入的上下限等）。
2. **控制步骤**：

   - 给定初始状态和当前目标位置，MPC会计算未来的一段时间内（通过预测范围 `prediction_horizon`）的最优控制输入。
   - 在每个时间步骤，MPC优化当前控制输入，使得系统的未来轨迹尽可能接近期望的轨迹（目标位置）。
   - 通过解优化问题，得到一个控制输入序列，通常我们只应用第一个控制输入，然后再在下一时刻重复上述过程。

### 优化问题的构造

在MPC中，最优控制输入的计算通常是通过解决一个优化问题来完成。我们假设系统模型是已知的（即，我们知道如何根据当前状态和控制输入来预测下一时刻的状态）。

#### 1. **运动学模型**：

为了描述四轮全向底盘的运动，我们用以下的简化模型：

- **状态变量**：机器人在平面上的位置 `(x, y)` 和朝向角度 `theta`。
- **控制输入**：线速度 `vx` 和角速度 `wz`。

根据这些变量，系统的动态方程可以写作：
\[
\begin{aligned}
\dot{x} &= vx \cdot \cos(\theta) \\
\dot{y} &= vx \cdot \sin(\theta) \\
\dot{\theta} &= wz
\end{aligned}
\]
这个模型是描述机器人如何在平面内移动的基础模型。通过给定速度和角速度，机器人可以在未来的时刻预测出自己的位置。

#### 2. **优化目标函数**：

MPC的核心思想是最小化一个目标函数，该函数衡量了未来轨迹和目标之间的误差。为了实现轨迹跟踪，目标函数通常由两部分组成：

- **状态误差**：期望的状态（如目标位置）与预测状态之间的差距。
- **控制输入的平滑性**：为了避免控制输入的突变，我们希望控制输入在一段时间内尽量平滑。

目标函数可以表示为：
\[
\text{Cost} = \sum_{i=1}^{N} \left( \|x_i - x_{\text{target}}\|^2 + \|y_i - y_{\text{target}}\|^2 \right) + \lambda \sum_{i=1}^{N-1} \|u_i - u_{i-1}\|^2
\]
其中：

- \( x_i, y_i \) 是预测的状态。
- \( x_{\text{target}}, y_{\text{target}} \) 是目标位置。
- \( u_i \) 是控制输入（线速度和角速度）。
- \( \lambda \) 是控制输入平滑性的加权因子。

#### 3. **约束条件**：

除了最小化目标函数外，MPC还考虑一些约束条件，例如：

- **控制输入约束**：控制输入如速度可能有最大和最小值限制（例如，最大速度、最大角速度等）。
- **状态约束**：机器人不能越过某些边界（例如，地图的边缘或障碍物）。

在代码中，约束是通过控制输入的上下界 `lb` 和 `ub` 来实现的：

```matlab
lb = -1 * ones(1, prediction_horizon * 2);  % 下界
ub = 1 * ones(1, prediction_horizon * 2);   % 上界
```

#### 4. 优化求解器：

   为了求解优化问题，我们使用MATLAB中的 fmincon 优化求解器。这个函数通过最小化目标函数来找到最优的控制输入序列。它的调用方式如下：

```matlab
u = fmincon(@(u) cost_function(u, state, target_pos, prediction_horizon, time_step), u_initial, [], [], [], [], lb, ub, [], options);
```

fmincon 会返回一个控制输入序列 u，然后只使用第一个控制输入（u(1)）来驱动机器人，并在下一时刻再次进行优化。

#### 5. 控制更新：

每次优化之后，机器人会根据计算出的控制输入更新自己的状态，并使用新的目标位置继续进行优化。这是一个滚动优化过程，每个时刻都在重新计算最优控制输入。
##### 推导过程
*    初始化状态和目标位置：给定初始状态 [x, y, theta] 和目标位置 target_pos。
*    预测未来状态：使用运动学模型预测未来状态，通常使用离散化的Euler方法。
*    定义目标函数：构建目标函数，包含状态误差和控制输入的平滑性。
*    求解优化问题：通过 fmincon 等优化工具，最小化目标函数，得到最优控制输入。
*    更新状态和目标：根据当前控制输入更新机器人状态，检查是否到达目标位置，若到达，则更新目标点。
*    循环执行：重复步骤2到5，直到完成整个任务。

### 总结

   MPC的工作原理：在每个时刻，MPC优化问题通过最小化状态误差和控制输入平滑性，求解出最优控制输入，机器人根据这些控制输入沿着目标路径行驶。
   目标函数：目标函数设计为最小化预测轨迹和目标位置之间的误差，同时保持控制输入的平滑性。
   优化过程：通过滚动优化和约束控制输入，MPC能够根据当前状态和目标动态调整控制输入，适应环境变化。
